\documentclass{article}

\usepackage{framed}
\usepackage{fullpage}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{amsfonts}
\usepackage{mathpartir}
\usepackage{xspace}

\newcommand{\inferrewrite}[2]{\ensuremath{\inferrule{#1}{#2}}}
\newcommand{\rewrite}[6]{#1,#2,#3 \mathrel{\longrightarrow} #4,#5,#6}
\newcommand{\mover}[2]{{#1}\,:\,\mathbb{#2}\xspace}
\newcommand{\parpipe}{\mathrel{\|}}
\newcommand{\for}[3]{\mathsf{for} (#1 : #2) \{#3\}}
\newcommand{\while}[2]{\mathsf{while} (#1) \{#2\}}
\newcommand{\parp}[2]{{#1}\parpipe{#2}}
\newcommand{\symm}[3]{\Pi{#1}:{#2}.\;#3}

\newcommand{\unfolded}[1]{#1^{*}}
\newcommand{\reduced}[1]{#1_{\bot}}

\newcommand{\fn}[1]{\mathsf{#1}}
\newcommand{\chan}[1]{\fn{chan}(#1)}

\newcommand{\sub}[3]{#1[#3/#2]}
\newcommand{\emptytrace}{\epsilon}
\newcommand{\var}[1]{\mathtt{#1}}
\newcommand{\stmt}[2]{#1\,\triangleright\,\mathtt{#2}}
\newcommand{\recv}[2]{\stmt{#1}{#2 := recv}()}
\newcommand{\send}[3]{\stmt{#1}{send}(#2,#3)}
\newcommand{\assert}[1]{\mathtt{assert}\;#1}

\newcommand{\ctx}{\Gamma}
\newcommand{\trace}{\Delta}
\newcommand{\abs}[1]{\alpha(#1)}
\begin{document}

\newif\ifconc
%%\conctrue
\concfalse

\begin{framed}
\textsc{Primitive Operations}
\[
\inferrule[Send]{
  \ifconc
    \trace \vDash p 
  \else
    \trace \vdash p = j
  \fi
}{
  \rewrite{\ctx}
          {\ifconc \trace \else \trace \fi}
          {\send{i}{p}{m}}
          {\ctx[(i,j)\mapsto\ctx(i,j) \cdot m]}
          {\ifconc \trace\ \else \trace \fi}
          {\emptytrace}
}
\]

\[
\inferrule[Receive]{
  \ctx(i,j) = \mathtt{m} \cdot M
}{
  \rewrite{\ctx}
          {\ifconc \trace \else \trace \fi}
          {\recv{j}{x}}
          {\ctx[(i,j)\mapsto M]}
          {\ifconc \trace \else 
            \trace \uplus \{\mathtt{x} \mapsto \mathtt{m}\}
           \fi}
          {\emptytrace}
}
\]
\end{framed}

\begin{framed}
\textsc{Structural Rules}
\[
  \inferrule[Prefix] {
    \rewrite{\ctx}
            {\trace}
            {\cdots \parpipe P_i \parpipe \cdots}
            {\ctx'}
            {\trace'}
            {\cdots \parpipe Q_i \parpipe \cdots}
  }{
    \rewrite{\ctx}
            {\trace}
            {\cdots \parpipe P_i;R_i \parpipe \cdots}
            {\ctx'}
            {\trace'}
            {\cdots \parpipe Q_i;R_i \parpipe \cdots}
  }
\]

\[
  \inferrule[Symm-Prefix]{
    \rewrite{\ctx}
            {\trace}
            {\parp{P(\unfolded{i});Q(\unfolded{i})}{P(\reduced{i});Q(\reduced{i})}}
            {\ctx}
            {\trace'}
            {\parp{P(\unfolded{i})}{P(\reduced{i})};
             \parp{Q(\unfolded{i})}{Q(\reduced{i})}}
  }{
    \rewrite{\ctx}
            {\trace}
            {\symm{i}{I}{P(i);Q(i)}}
            {\ctx}
            {\trace'}
            {\symm{i}{I}{P(i)};\symm{i}{I}{Q(i)}}
  }
\]
\[
  \inferrule[Framing] {
    \rewrite{\ctx}
            {\trace}
            {P}
            {\ctx'}
            {\trace'}
            {Q}
  }{
    \rewrite{\ctx}
            {\trace}
            {\parp{P}{R}}
            {\ctx'}
            {\trace'}
            {\parp{Q}{R}}
  }
% \]
% \quad
% \[
  % \inferrule[Consequence] {
  %   \rewrite{\ctx}{\trace}{P}{\ctx'}{P'}\\
  %   \rewrite{\ctx'}{P'}{S'}{\ctx''}{P''}
  % }{
  %   \rewrite{\ctx}{P}{S;S'}{\ctx''}{P''}
  % }
% \]
% \quad
% \[
% \inferrule[Push Trace]{
% \rewrite{\ctx}{P}{S}{\ctx'}{Q}
% }{
% \rewrite{\ctx}{P}{\emptytrace}{\ctx}{S;Q}
% }
\]
\end{framed}

\begin{framed}
\textsc{Iteration}
\[
\inferrule[Strong-Update]
{
  \unfolded{i} \textit{fresh}\\
  \rewrite{\ctx}{\trace}{\parp{P(\unfolded{i})}{Q(\unfolded{i})}}
          {\ctx}{\trace \uplus \trace'}{\emptytrace}
}
{
 \rewrite{\ctx}
         {\trace}
         {\parp{\for{i}{I}{P(i)}}
               {\for{j}{I}{Q(j)}}}
         {\ctx}
         {\ifconc \trace;\for{i}{I}{\sub{\trace'}{\unfolded{i}}{i}} \else 
           \trace
           \fi
         }
         {\emptytrace}
}
\]

\[
\inferrule[Fuse-Loop-2]
{
  \unfolded{i} \textit{fresh}\\
  \rewrite{\ctx}{\trace        }{\parp{P(\unfolded{i})}{Q(\unfolded{i})}}
          {\ctx}{\ifconc \trace;\trace' \else \trace \uplus \trace' \fi}{\emptytrace}\\
  \ifconc
  \else
  \trace'' = \{ x(i) \mapsto c \mid x_{\unfolded{i}} \mapsto c \in \trace'
 \}
  \fi
}
{
 \rewrite{\ctx}
         {\trace}
         {\parp{\for{i}{I}{P(i)}}
               {\symm{j}{I}{Q(j)}}}
         {\ctx}
         {\ifconc \trace;\for{i}{I}{\sub{\trace'}{\unfolded{i}}{i}} \else
          \trace \uplus \trace''
          \fi}
         {\emptytrace}
}
\]
\end{framed}
\end{document}
%%% Local Variables:
%%% mode: latex
%%% TeX-master: t
%%% End:
